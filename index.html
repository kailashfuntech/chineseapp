<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChinesePro">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2909/2909489.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/2909/2909489.png" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <title>Chinese Master Pro</title>
    <style>
        /* --- NEW AESTHETIC VARIABLES --- */
        :root { 
            --font-main: 'Quicksand', sans-serif;
            --bg-gradient-start: #fff1f8; 
            --bg-gradient-end: #ffd1dc;   
            --primary: #ff9eb5;           
            --primary-dark: #f0809b;      
            --accent-purple: #b39ddb;     
            --text-dark: #5d4037;         
            --text-light: #8d6e63;        
            --shadow-soft: 0 15px 35px rgba(255, 158, 181, 0.3), 0 5px 15px rgba(0,0,0,0.05);
            --shadow-inset: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        body { 
            margin: 0; 
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); 
            color: var(--text-dark); 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
        }

        /* UPDATED: Flexible width for Tablets */
        .app-container { 
            width: 95%;           /* Changed from fixed 900px to 95% */
            max-width: 900px;     /* Stop getting bigger than 900px */
            height: 90vh;         /* Use viewport height */
            max-height: 700px;
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px); 
            border-radius: 35px; 
            display: flex; 
            box-shadow: var(--shadow-soft); 
            overflow: hidden; 
            position: relative; 
            border: 3px solid #fff; 
        }

        /* UPDATED: Tablet Breakpoint (Increased from 600px to 950px) */
        @media (max-width: 950px) { 
            .app-container { 
                width: 100% !important; 
                height: 100vh !important; 
                max-width: none !important; 
                max-height: none !important;
                border-radius: 0 !important; 
                border: none;
            } 
            .sidebar { display: none !important; } 
            .mobile-nav { display: flex !important; } 
            body { background: var(--bg-gradient-start); }
        }
        
        .sidebar { 
            width: 220px; 
            background: rgba(255, 245, 250, 0.6); 
            padding: 25px 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            border-right: 1px solid rgba(255, 158, 181, 0.2); 
            overflow-y: auto; 
        }
        .sidebar h3 { color: var(--text-dark); margin-bottom: 20px; font-weight: 700;}

        .cat-row { display: flex; gap: 8px; align-items: center; width: 100%; }
        .mobile-nav { display: none; overflow-x: auto; gap: 10px; padding: 15px; background: rgba(255,255,255,0.9); border-bottom: 1px solid #eee; scrollbar-width: none; }
        
        .cat-btn { 
            background: #fff; 
            border: 2px solid transparent;
            padding: 12px 18px; 
            border-radius: 25px; 
            text-align: left; 
            cursor: pointer; 
            font-weight: 700; 
            color: var(--text-light); 
            white-space: nowrap; 
            flex-grow: 1; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
            font-family: var(--font-main);
        }
        .cat-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 158, 181, 0.25); color: var(--primary); }
        .cat-btn.active { 
            background: linear-gradient(to right, var(--primary), var(--primary-dark)); 
            color: white; 
            box-shadow: 0 8px 20px rgba(255, 158, 181, 0.4);
        }
        .del-btn { background: #fff0f0; color: #ff6b6b; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; transition: all 0.2s; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .del-btn:hover { background: #ffdbdb; transform: scale(1.1);}
        
        .main-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; background: transparent; overflow-y: auto; padding-bottom: 50px; }
        
        .stats-bar { 
            width: 90%; margin-top: 20px; border-radius: 20px;
            padding: 15px 25px; box-sizing: border-box; display: flex; justify-content: space-around; align-items: center; 
            font-weight: bold; color: var(--text-light); font-size: 16px; 
            background: rgba(255,255,255,0.7); 
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            z-index: 20; 
            border: 1px solid rgba(255,255,255,0.8);
        }
        .stat-item{ display: flex; align-items: center; gap: 8px; color: var(--text-dark); }
        .xp-badge { color: #ffd54f; filter: drop-shadow(0 2px 3px rgba(255, 213, 79, 0.4)); } 
        .streak-badge { color: #ff8a65; filter: drop-shadow(0 2px 3px rgba(255, 138, 101, 0.4)); } 
        .level-badge { color: #4db6ac; filter: drop-shadow(0 2px 3px rgba(77, 182, 172, 0.4)); }

        #topicInput { 
            padding: 12px 20px; border-radius: 25px; border: 2px solid #eee; width: 140px; 
            outline: none; transition: all 0.3s; font-family: var(--font-main); color: var(--text-dark);
            background: #fffafa; box-shadow: var(--shadow-inset);
        }
        #topicInput:focus { border-color: var(--accent-purple); background: #fff; }
        
        button[onclick="generateVocab()"] { 
            padding: 12px 25px !important; 
            background: linear-gradient(to right, #ce93d8, #ec94b4) !important; 
            color:white; border:none; border-radius: 25px !important; cursor:pointer; font-weight: 700; font-family: var(--font-main);
            box-shadow: 0 5px 15px rgba(206, 147, 216, 0.4); transition: all 0.3s;
        }
        button[onclick="generateVocab()"]:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(206, 147, 216, 0.6); }

        .card-container { perspective: 1000px; width: 320px; height: 420px; margin-bottom: 20px; margin-top: 20px;}
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; cursor: pointer; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            background: linear-gradient(to bottom right, #ffffff, #fff5f8); 
            border-radius: 35px; 
            box-shadow: var(--shadow-soft); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 4px solid #fff; 
        }
        .card-back { transform: rotateY(180deg); background: linear-gradient(to bottom right, #f0f8ff, #e1efff); }
        
        .emoji-display { font-size: 50px; margin-bottom: 10px; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.1)); }
        .character { font-size: 80px; font-weight: 700; color: var(--text-dark); text-shadow: 3px 3px 0px #fff, 5px 5px 15px rgba(255, 158, 181, 0.3); }
        .pinyin { font-size: 26px; color: var(--primary-dark); margin-top: 10px; font-weight: 700;}
        .english { font-size: 22px; color: var(--text-light); margin-top: 5px; font-weight: 700; padding: 0 20px; text-align: center;}
        
        .action-bar { display: flex; gap: 18px; margin-top: 25px; }
        .icon-btn { 
            width: 55px; height: 55px; border-radius: 50%; 
            background: #fff; border: 2px solid #fff5f8;
            color: var(--primary); font-size: 24px; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { transform: translateY(-5px) scale(1.05); background: var(--primary); color: white; box-shadow: 0 10px 20px rgba(255, 158, 181, 0.4); border-color: var(--primary);}
        .icon-btn:active { transform: scale(0.95); }

        .next-btn { 
            padding: 16px 50px; 
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white; border: none; border-radius: 35px; font-size: 20px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 10px 30px rgba(255, 158, 181, 0.5);
            margin-top: 15px; margin-bottom: 30px; font-family: var(--font-main); letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .next-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(255, 158, 181, 0.7); }
        .next-btn:active { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(255, 158, 181, 0.5); }
        
        .overlay { background: rgba(255, 252, 254, 0.95); backdrop-filter: blur(15px); }
        .overlay h3 { color: var(--text-dark); font-size: 28px; }
        
        .canvas-container { border: 4px dashed var(--primary-dark); border-radius: 25px; background: #fff; box-shadow: var(--shadow-inset);}
        .guide-char { color: #eee; }
        
        .puzzle-area { width: 90%; text-align: center; }
        #puzzlePinyin { color: var(--accent-purple) !important; }
        #puzzleTarget { color: var(--text-dark) !important; font-size: 24px;}
        .drop-zone { min-height: 70px; border-bottom: 3px dashed #ecc6d9; background: rgba(255,255,255,0.5); border-radius: 15px; margin-bottom: 25px; padding: 15px;}
        .chip { 
            padding: 10px 16px; background: #fff; border: 2px solid var(--primary); border-radius: 20px; 
            cursor: pointer; font-size: 18px; font-weight: 700; color: var(--text-dark);
            box-shadow: 0 4px 0 var(--primary-dark); transition: all 0.2s; font-family: var(--font-main);
        }
        .chip:active { transform: translateY(4px); box-shadow: none; }
        
        #error-box { background: #fff0f0; border: 2px solid #ffb3b3; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="error-box">
        <h3 style="color:#8d4a4a; margin-top:0;">‚ö†Ô∏è AI Error</h3>
        <p id="error-text" style="font-family:monospace; background:rgba(255,255,255,0.7); padding:15px; font-size:12px; border-radius: 10px;"></p>
        <button onclick="document.getElementById('error-box').style.display='none'" style="width:100%; padding:12px; background:#ff0000; color:white; border:none; border-radius:15px; font-weight:bold; cursor:pointer;">Close</button>
    </div>

    <div class="app-container">
        <div class="sidebar" id="pcSidebar"></div>
        <div style="flex-grow:1; display:flex; flex-direction:column; width:100%;">
            <div class="mobile-nav" id="mobileNav"></div>
            
            <div class="main-area">
                <div class="stats-bar">
                    <div class="stat-item"><span class="streak-badge">üî•</span> <span id="streakDisplay">0</span> Days</div>
                    <div class="stat-item"><span class="level-badge">üèÜ</span> Lvl <span id="levelDisplay">1</span></div>
                    <div class="stat-item"><span class="xp-badge">‚≠ê</span> <span id="xpDisplay">0</span> XP</div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:10px; z-index:10; margin-top: 20px; align-items: center;">
                    <input type="text" id="topicInput" placeholder="‚ú® Topic...">
                    <button onclick="generateVocab()">Generate</button>
                </div>
                <div id="loading" style="display:none; color:var(--accent-purple); font-weight:bold; margin-bottom:10px;">‚ú® Connecting to AI...</div>
                <div id="statusMsg" style="color:#aaa; font-weight:bold; margin-bottom:5px;">Tap Mic to Speak</div>

                <div id="writeOverlay" class="overlay">
                    <h3>Write Character</h3>
                    <div class="canvas-container">
                        <div id="guideChar" class="guide-char"></div>
                        <canvas id="canvas" width="280" height="280"></canvas>
                    </div>
                    
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top: 20px;">
                        <button class="cat-btn" onclick="toggleGuide()">üëÅÔ∏è Guide</button>
                        <button class="cat-btn" style="background:linear-gradient(to right, #a8e063, #56ab2f); color:white; border:none;" onclick="checkWriting()">‚úÖ CHECK</button>
                        <button class="cat-btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
                        <button class="cat-btn" style="background:linear-gradient(to right, #ff5f6d, #ffc371); color:white; border:none;" onclick="toggleOverlay('writeOverlay')">Close</button>
                    </div>
                </div>

                <div id="puzzleOverlay" class="overlay">
                    <h4 id="puzzlePinyin" style="margin:0 0 10px 0;">Pinyin Hint</h4>
                    <h3 id="puzzleTarget" style="margin-top:0; margin-bottom: 25px;">Translate...</h3>
                    <div class="puzzle-area">
                        <div class="drop-zone" id="dropZone"></div>
                        <div class="word-bank" id="wordBank"></div>
                    </div>
                    <div style="margin-top:25px; display:flex; gap:15px;">
                        <button class="cat-btn active" onclick="checkPuzzle()">Check Answer</button>
                        <button class="cat-btn" onclick="toggleOverlay('puzzleOverlay')">Close</button>
                    </div>
                </div>

                <div class="card-container">
                    <div class="card" id="card" onclick="flipCard()">
                        <div class="card-face">
                            <div class="emoji-display" id="emojiDisplay"></div>
                            <div class="character" id="charDisplay">‰Ω†Â•Ω</div>
                            <div class="action-bar">
                                <button class="icon-btn" onclick="playAudio(event)">üîä</button>
                                <button class="icon-btn" onclick="toggleOverlay('writeOverlay', event)"></button>
                                <button class="icon-btn" id="micBtn" onclick="toggleMic(event)">üé§</button>
                                <button class="icon-btn" onclick="startPuzzle(event)">üß©</button>
                            </div>
                        </div>
                        <div class="card-face card-back">
                            <div class="pinyin" id="pinyinDisplay">n«ê h«éo</div>
                            <div class="english" id="englishDisplay">Hello</div>
                        </div>
                    </div>
                </div>
                <button class="next-btn" onclick="nextCard()">Next Word ‚û°</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        const GEMINI_API_KEY = "AIzaSyBelTcnVhkoC-KeVkiM07ZGj5ON1qyd7Ks"; 
        let activeModel = null; 

        // --- GAME STATS ---
        let xp = 0;
        let level = 1;
        let streak = 0;
        let lastLogin = "";

        let vocabList = [
            { char: "‰Ω†Â•Ω", pinyin: "n«ê h«éo", en: "Hello", emoji: "", cat: "Greetings", s: {en: "How are you doing today?", pinyinSentence: "n«ê jƒ´n tiƒÅn zƒõn me y√†ng", parts: ["‰Ω†","‰ªä","Â§©","ÊÄé","‰πà","Ê†∑"], full:"‰Ω†‰ªäÂ§©ÊÄé‰πàÊ†∑"} },
            { char: "Áå´", pinyin: "mƒÅo", en: "Cat", emoji: "", cat: "Animals", s: {en: "My cat likes to sleep on the bed.", pinyinSentence: "w«í de mƒÅo x«ê huan z√†i chu√°ng sh√†ng shu√¨ ji√†o", parts: ["Êàë","ÁöÑ","Áå´","Âñú","Ê¨¢","Âú®","Â∫ä","‰∏ä","Áù°","Ëßâ"], full:"ÊàëÁöÑÁå´ÂñúÊ¨¢Âú®Â∫ä‰∏äÁù°Ëßâ"} }
        ];

        let categories = ["All", "Generated", "Greetings", "Animals"];
        let currentList = vocabList;
        let currentIndex = 0;
        const statusEl = document.getElementById('statusMsg');

        // --- SAVE & LOAD ---
        function saveData() {
            const data = { vocab: vocabList, cats: categories, xp: xp, level: level, streak: streak, lastLogin: lastLogin };
            localStorage.setItem('chinesePro_data', JSON.stringify(data));
            updateStatsUI();
        }
        function loadData() {
            const saved = localStorage.getItem('chinesePro_data');
            if(saved) {
                const data = JSON.parse(saved);
                vocabList = data.vocab || vocabList;
                categories = data.cats || categories;
                xp = data.xp || 0;
                level = data.level || 1;
                streak = data.streak || 0;
                lastLogin = data.lastLogin || "";
            }
            checkStreak();
            updateStatsUI();
        }

        // --- GAMIFICATION ---
        function addXP(amount) {
            xp += amount;
            if (Math.floor(xp / 100) + 1 > level) {
                level++;
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff9eb5', '#b39ddb', '#ffd54f'] });
                alert(`LEVEL UP! You are now Level ${level}`);
            }
            saveData();
        }
        function checkStreak() {
            const today = new Date().toDateString();
            if (lastLogin !== today) { streak++; lastLogin = today; saveData(); }
        }
        function updateStatsUI() {
            document.getElementById('xpDisplay').innerText = xp;
            document.getElementById('levelDisplay').innerText = level;
            document.getElementById('streakDisplay').innerText = streak;
        }

        // --- DELETE CATEGORY ---
        function deleteCategory(catName) {
            if(catName === 'All') return alert("Cannot delete 'All'.");
            if(confirm(`Delete "${catName}"?`)) {
                vocabList = vocabList.filter(w => w.cat !== catName);
                categories = categories.filter(c => c !== catName);
                saveData();
                renderCategories();
                document.querySelectorAll('.cat-btn')[0].click(); 
            }
        }

        function renderCategories() {
            const pcDiv = document.getElementById('pcSidebar');
            const mobileDiv = document.getElementById('mobileNav');
            pcDiv.innerHTML = "<h3 style='margin-top:0;'>Categories</h3>";
            mobileDiv.innerHTML = "";
            categories.forEach(cat => {
                let row = document.createElement('div'); row.className = 'cat-row';
                let btn = document.createElement('button'); btn.className = 'cat-btn'; btn.innerText = cat;
                if(cat === 'All') btn.classList.add('active');
                btn.onclick = () => {
                    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.cat-btn').forEach(b => { if(b.innerText === cat) b.classList.add('active')});
                    if(cat === 'All') currentList = vocabList; else currentList = vocabList.filter(w => w.cat === cat);
                    if(currentList.length === 0) alert("No words here yet!"); else nextCard();
                };
                row.appendChild(btn);
                if(cat !== 'All') {
                    let delBtn = document.createElement('button'); delBtn.className = 'del-btn'; delBtn.innerHTML = "&times;"; 
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteCategory(cat); };
                    row.appendChild(delBtn);
                }
                pcDiv.appendChild(row);
                let mobileBtn = btn.cloneNode(true); mobileBtn.onclick = btn.onclick; mobileDiv.appendChild(mobileBtn);
            });
            let clearBtn = document.createElement('button'); clearBtn.innerText = "üóëÔ∏è Reset Progress";
            clearBtn.style.marginTop = "20px"; clearBtn.style.width = "100%"; clearBtn.style.padding = "12px"; clearBtn.style.background = "#fd91b1"; clearBtn.style.color = "#ecc6d9"; clearBtn.style.border = "none"; clearBtn.style.borderRadius = "20px"; clearBtn.style.fontWeight = "bold"; clearBtn.style.cursor = "pointer";
            clearBtn.onclick = () => { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); }};
            pcDiv.appendChild(clearBtn);
        }

        // --- AI LOGIC (COMPLEX SENTENCES) ---
        async function getBestModel() {
            if (activeModel) return activeModel;
            const loading = document.getElementById('loading');
            loading.innerText = "‚ú® Finding AI..."; loading.style.display = 'block';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const validModel = data.models.find(m => m.supportedGenerationMethods.includes("generateContent") && (m.name.includes("flash") || m.name.includes("pro")));
                if (validModel) { activeModel = validModel.name.replace("models/", ""); return activeModel; } 
                else { throw new Error("No compatible models."); }
            } catch (e) { activeModel = "gemini-1.5-flash"; return activeModel; }
        }

        async function generateVocab() {
            const topic = document.getElementById('topicInput').value;
            if(!topic) return alert("Please enter a topic!");
            const loading = document.getElementById('loading'); loading.style.display = 'block';
            
            try {
                const modelName = await getBestModel();
                loading.innerText = `‚ú® Thinking (${modelName})...`;
                // PROMPT UPDATED FOR COMPLEX SENTENCES + PINYIN
                const prompt = `Generate 5 Chinese words about "${topic}". Return JSON array. 
                Each word must have a COMPLEX sentence (8-15 characters, HSK 2-3 level).
                Format: [{"char":"word","pinyin":"pinyin","en":"mean","emoji":"üöÄ","cat":"${topic}","s":{"en":"Complex English Sentence","pinyinSentence":"Complete Pinyin for sentence","parts":["Split","Chars"],"full":"FullSentence"}}]`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const newWords = JSON.parse(text);

                vocabList = [...newWords, ...vocabList];
                if(!categories.includes(topic)) categories.push(topic);
                saveData(); renderCategories(); currentList = vocabList.filter(w => w.cat === topic); nextCard();
                loading.style.display = 'none'; alert(`Success! Saved ${newWords.length} new words.`);
            } catch (error) {
                loading.style.display = 'none';
                document.getElementById('error-box').style.display = 'block';
                document.getElementById('error-text').innerText = error.message;
            }
        }

        // --- APP LOGIC ---
        function nextCard() {
            document.getElementById('card').classList.remove('is-flipped');
            statusEl.innerText = "Tap Mic to Speak"; statusEl.style.color = "#aaa";
            document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
            setTimeout(() => {
                if(currentList.length === 0) currentList = vocabList;
                currentIndex = Math.floor(Math.random() * currentList.length);
                const word = currentList[currentIndex];
                document.getElementById('emojiDisplay').innerText = word.emoji || "‚ú®";
                document.getElementById('charDisplay').innerText = word.char;
                document.getElementById('pinyinDisplay').innerText = word.pinyin;
                document.getElementById('englishDisplay').innerText = word.en;
            }, 300);
        }
        window.loadRandomWord = nextCard;

        function flipCard() {
            if(document.getElementById('writeOverlay').style.display === 'flex') return;
            if(document.getElementById('puzzleOverlay').style.display === 'flex') return;
            document.getElementById('card').classList.toggle('is-flipped');
        }

        function playAudio(e) {
            if(e) e.stopPropagation();
            const u = new SpeechSynthesisUtterance(document.getElementById('charDisplay').innerText);
            u.lang = 'zh-CN'; window.speechSynthesis.speak(u);
        }

        function toggleOverlay(id, e) {
            if(e) e.stopPropagation();
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            if(id === 'writeOverlay') { 
                const char = document.getElementById('charDisplay').innerText;
                document.getElementById('guideChar').innerText = char;
                clearCanvas();
                // Enable guide by default
                document.getElementById('guideChar').style.display = 'flex';
            }
        }

        // --- WRITING LOGIC ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.strokeStyle = "#5d4037"; // Softer brown stroke
        let isDrawing = false;
        function startDraw(e) { isDrawing = true; draw(e); }
        function endDraw() { isDrawing = false; ctx.beginPath(); }
        function draw(e) { 
            if(!isDrawing) return; e.preventDefault(); 
            const r = canvas.getBoundingClientRect(); 
            const x = (e.clientX||e.touches[0].clientX)-r.left; 
            const y = (e.clientY||e.touches[0].clientY)-r.top; 
            ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y); 
        }
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('touchmove', draw);
        
        function clearCanvas() { 
            ctx.clearRect(0,0,280,280); 
            document.getElementById('guideChar').style.color = "#eee"; 
        }

        function toggleGuide() {
            const guide = document.getElementById('guideChar');
            guide.style.display = (guide.style.display === 'none') ? 'flex' : 'none';
        }

        function checkWriting() {
            // 1. Show Perfect Character in Green
            const guide = document.getElementById('guideChar');
            guide.style.display = 'flex';
            guide.style.color = "#a8e063"; // Softer Green for correction
            
            // 2. Add Rewards
            addXP(10);
            confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 }, colors: ['#ff9eb5', '#b39ddb'] });

            // 3. Move On (Auto Close)
            setTimeout(() => {
                toggleOverlay('writeOverlay');
                guide.style.color = "#eee"; // Reset
                clearCanvas();
            }, 1200); // 1.2 second delay
        }

        // --- PUZZLE LOGIC ---
        let puzzleSentence = [];
        window.startPuzzle = (e) => {
            e.stopPropagation(); toggleOverlay('puzzleOverlay');
            const word = currentList[currentIndex];
            if(!word.s) return alert("No sentence available");
            
            document.getElementById('puzzleTarget').innerText = word.s.en;
            // NEW: Show Pinyin Hint
            document.getElementById('puzzlePinyin').innerText = word.s.pinyinSentence || "";

            const bank = document.getElementById('wordBank'); bank.innerHTML = "";
            const zone = document.getElementById('dropZone'); zone.innerHTML = "";
            puzzleSentence = [];
            [...word.s.parts].sort(()=>Math.random()-0.5).forEach(part => {
                let c = document.createElement('div'); c.className = 'chip'; c.innerText = part;
                c.onclick = () => { 
                    if(c.parentElement===bank) { zone.appendChild(c); puzzleSentence.push(part); }
                    else { bank.appendChild(c); puzzleSentence = puzzleSentence.filter(p=>p!==part); }
                };
                bank.appendChild(c);
            });
            window.checkPuzzle = () => {
                if(puzzleSentence.join('') === word.s.full) { 
                    document.getElementById('puzzleTarget').innerText="Correct! (+20 XP)"; 
                    document.getElementById('puzzleTarget').style.color="#a8e063"; 
                    addXP(20); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#ff9eb5', '#b39ddb'] });
                }
                else { document.getElementById('puzzleTarget').innerText="Try Again"; document.getElementById('puzzleTarget').style.color="#ff5f6d"; }
            }
        }
        
        // --- MIC ---
        let recognition;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.onresult = (e) => {
                const s = e.results[0][0].transcript;
                if(s.includes(document.getElementById('charDisplay').innerText)) { 
                    statusEl.innerText="Correct! (+10 XP)"; statusEl.style.color="#a8e063"; playAudio(); addXP(10);
                }
                else { statusEl.innerText="Heard: " + s; statusEl.style.color="#ff5f6d"; }
            };
        }
        window.toggleMic = (e) => { e.stopPropagation(); if(recognition) recognition.start(); else alert("Mic not supported"); }

        loadData(); renderCategories(); nextCard();
    </script>
</body>
</html>